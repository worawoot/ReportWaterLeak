<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แจ้งเหตุน้ำประปา/ท่อแตกรั่ว</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
    /* ตั้งค่า Font ให้เป็น IBM Plex Sans Thai */
    body {
        font-family: 'IBM Plex Sans Thai', sans-serif !important;
        font-weight: 600 !important;
    }
        
    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }        
    </style>
    
</head>
<body class="bg-slate-100 min-h-screen">

<div id="loadingOverlay" class="loading-overlay">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
    <p id="loadingText" class="text-gray-600 font-semibold">กรุณารอสักครู่...</p>
</div>
    
<div class="max-w-md m-auto p-2">
        <form>
            <div class="bg-white rounded-lg p-10 shadow-md"> 

                <!-- START: ส่วนหัว -->
                <div class="text-center mb-1">
                    <div class="flex items-center justify-center space-x-3 mb-1">
                        <img src="https://firebasestorage.googleapis.com/v0/b/webapp-c8c38.appspot.com/o/th-full-white.png?alt=media&token=88a41cdb-27fd-4c98-8d11-a390ef103163" 
                             alt="MWA Logo" 
                             onerror="this.onerror=null;this.src='https://placehold.co/48x48/007bff/ffffff?text=MWA'"
                             class="h-12 w-auto object-contain">
                        <h1 class="text-2xl font-bold text-blue-600">ระบบแจ้งเหตุน้ำประปา</h1> 
                    </div>
                    <p class="text-sm text-gray-500 font-medium mb-2">การประปานครหลวง(สาขาลาดพร้าว)</p>
                </div>
                <!-- END: ส่วนหัว -->
                
                <!-- ส่วนแสดงผลรูปโปรไฟล์และปุ่มอัพโหลด -->
                <div class="mb-5 text-center mt-0">
                    <div class="relative mx-auto w-full h-56 mb-4 group">
                        <img src="https://drive.google.com/thumbnail?id=17Ejxsa6GFTFrpoKFkoXna-KudkgmPwHW" 
                             alt="Profile Image" 
                             id="preview" 
                             class="w-full h-56 object-cover rounded-2xl border-4 border-white shadow-lg mx-auto bg-slate-100">                        
                        
                        <!-- ปุ่มอัพโหลดรูปไอคอนกล้อง -->
                        <label for="file" class="absolute -bottom-2 -right-2 bg-white p-2.5 rounded-full shadow-md cursor-pointer hover:bg-blue-50 hover:text-blue-600 transition-all duration-200 border border-slate-200 group-hover:scale-110 active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600 hover:text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <input type="file" id="file" name="file" accept="image/*" class="hidden">
                        </label>
                    </div>

                    <div id="displayName" class="text-xl text-slate-700 font-bold mt-2 hidden"></div>                    
                    <p class="text-xs text-slate-400 mt-1">แตะที่รูปกล้องเพื่ออัปโหลดรูปถ่ายปัญหา <span style="color: #f90202">*</span></p>
                </div>
                
                <div class="flex flex-col">            
                <div class="mb-4">
                    <input type="text" class="hidden" id="userlineId" placeholder="lineId" name="userlineId" readonly>
                </div>

                <div class="mb-4">
                    <label for="keynumber3Id" class="block text-sm font-semibold text-gray-700 mb-2">หัวข้อ <span style="color: #f90202">*</span></label>
                    <select id="keynumber3Id" name="keynumber3Id" required
                        class="input-field w-full border border-blue-300 p-2 text-md rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="" disabled selected>กรุณาเลือกหัวข้อปัญหา</option>
                        <option value="ท่อประปาแตกรั่ว">ท่อประปาแตกรั่ว</option>
                        <option value="น้ำไม่ไหล/ไหลอ่อน">น้ำไม่ไหล/ไหลอ่อน</option>
                        <option value="น้ำขุ่น/มีกลิ่น">น้ำขุ่น/มีกลิ่น</option>
                    </select>
                </div>
                    
                <div class="mb-4">
                    <label for="nameId" class="block text-sm font-semibold text-gray-700 mb-2">ชื่อ-นามสกุล <span style="color: #f90202">*</span></label>
                    <input type="text" class="input-field w-full border border-blue-300 p-2 text-md rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="nameId" placeholder="กรอกชื่อและนามสกุล" name="nameId" required>
                </div>
                    
                <div class="mb-4">
                    <label for="keynumberId" class="block text-sm font-semibold text-gray-700 mb-2">เบอร์โทรศัพท์ (10 หลัก) <span style="color: #f90202">*</span></label>                    
                    <input type="tel" class="input-field w-full border border-blue-300 p-2 text-md rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="keynumberId" placeholder="เช่น 0812345678" pattern="^0\d{9}$" title="กรุณากรอกเบอร์โทรศัพท์ 10 หลัก ที่ขึ้นต้นด้วย 0" name="keynumberId" maxlength="10" inputmode="numeric" required>
                </div>
                    
                <div class="mb-6">
                    <label for="keynumber2Id" class="block text-sm font-semibold text-gray-700 mb-2">รายละเอียดเพิ่มเติม <span style="color: #f90202">*</span></label>
                    <textarea 
                        class="input-field w-full border border-blue-300 p-2 text-md rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        id="keynumber2Id" 
                        name="keynumber2Id" 
                        rows="4"
                        required
                        placeholder="ระบุจุดสังเกต หรือรายละเอียดปัญหาเพิ่มเติม"></textarea>
                </div>

                <!-- ลบส่วน Checkbox e-Bill/e-Tax ออกจาก UI -->
                    
                </div>
                <button type="button" id="submitBtn" class="bg-blue-500 text-center w-full text-white py-4 px-4 rounded-lg hover:bg-blue-700">ส่งข้อมูลแจ้งเหตุ</button>
                
                <footer class="text-center text-sm text-gray-600 mt-8">Copyright © 2025 WORAWOOT PHAENGPETCH</footer>
            </div>          
            
        </form>
</div>
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>

const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz9oiEei5V9ZYvcVPgzq_v1WWafS0YOclXh21MXlDZqsGQ0_WDrwxJq9YlEhvblZCr1RQ/exec'; 
const LIFF_ID = '1657790891-40VQpd6O';

const DEFAULT_AVATAR = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";

let url = `${WEB_APP_URL}`;
let fileInput = document.getElementById("file");
let imgPreview = document.getElementById("preview");
let userlineIdInput = document.getElementById("userlineId");
let nameIdInput = document.getElementById("nameId");
let keynumberIdInput = document.getElementById("keynumberId");
let keynumber2IdInput = document.getElementById("keynumber2Id");
let submitBtn = document.getElementById("submitBtn");
let keynumber3IdInput = document.getElementById("keynumber3Id");

// ลบตัวแปรอ้างอิงถึง Checkbox
// let keynumber4IdInput = document.getElementById("keynumber4Id");
// let keynumber5IdInput = document.getElementById("keynumber5Id");

const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');

let currentProfileImage = DEFAULT_AVATAR;

window.onload = function () {
    loadingText.innerText = "กำลังโหลดข้อมูลสมาชิก...";
    loadingOverlay.style.display = 'flex';
    initializeLiff();
};

async function initializeLiff() {
    try {
        await liff.init({ liffId: `${LIFF_ID}` });
        if (liff.isLoggedIn()) {
            await getUserProfile();
        } else {
            liff.login();
        }
    }catch (err) {
        console.error('LIFF Init failed', err);
        loadingOverlay.style.display = 'none';
        Swal.fire('Error', 'ไม่สามารถเชื่อมต่อกับ LINE ได้', 'error');
    }
}

async function getUserProfile() {
    try {
        const profile = await liff.getProfile();
        document.getElementById('userlineId').value = profile.userId;

        if (profile.displayName) {
            document.getElementById('displayName').innerText = profile.displayName;
        }
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการดึงข้อมูลโปรไฟล์:', error);
    } finally {
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 500);
    }
}

// ลบ Logic การ Auto-Select สำหรับ Checkbox

// --- Flex Message ---
async function sendFlexMessage() {

    if (!liff.isInClient()) {
        console.warn('Cannot send message: Not in LINE Client (External Browser)');
        return; 
    }

    // จัด Format เบอร์โทรศัพท์ (081-234-5678) เพื่อความสวยงาม
    let rawPhone = keynumberIdInput.value;
    let formattedPhone = rawPhone.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');

    const flexMessage = {
      "type": "flex",
      "altText": "แจ้งเหตุสำเร็จ",
      "contents": {
        "type": "bubble",
        "size": "mega",
        "header": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "box",
              "layout": "vertical",
              "contents": [
                {
                    "type": "text",
                    "text": "✓",
                    "size": "4xl",
                    "color": "#ffffff",
                    "weight": "bold",
                    "align": "center"
                }
              ],
              "backgroundColor": "#32CD32",
              "cornerRadius": "100px",
              "width": "60px",
              "height": "60px",
              "justifyContent": "center",
              "margin": "md"
            },
            {
              "type": "text",
              "text": "แจ้งเหตุสำเร็จ",
              "weight": "bold",
              "size": "xl",
              "color": "#ffffff",
              "margin": "md"
            },
            {
              "type": "text",
              "text": "ระบบได้รับข้อมูลของท่านแล้ว",
              "color": "#ffffffcc",
              "size": "xs"
            }
          ],
          "backgroundColor": "#00C2F3",
          "paddingAll": "xxl",
          "alignItems": "center"
        },
        "body": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "image",
                  "url": "https://firebasestorage.googleapis.com/v0/b/webapp-c8c38.appspot.com/o/th-full-white.png?alt=media&token=88a41cdb-27fd-4c98-8d11-a390ef103163",
                  "size": "xxs",
                  "aspectMode": "fit",
                  "flex": 0
                },
                {
                  "type": "text",
                  "text": "การประปานครหลวง (สาขาลาดพร้าว)",
                  "weight": "bold",
                  "size": "xs",
                  "color": "#999999",
                  "align": "end",
                  "gravity": "center",
                  "flex": 1
                }
              ],
              "margin": "none"
            },
            {
              "type": "separator",
              "margin": "lg"
            },
            {
              "type": "text",
              "text": "ข้อมูลผู้แจ้งเหตุ",
              "weight": "bold",
              "size": "sm",
              "color": "#00C2F3",
              "margin": "lg"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "หัวข้อที่แจ้ง",
                  "size": "sm",
                  "color": "#555555",
                  "flex": 2
                },
                {
                  "type": "text",
                  "text": keynumber3IdInput.value, 
                  "size": "xs",
                  "color": "#111111",
                  "align": "end",
                  "flex": 3,
                  "weight": "bold"
                }
              ],
              "margin": "md"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "ชื่อ-สกุล",
                  "size": "sm",
                  "color": "#555555",
                  "flex": 1
                },
                {
                  "type": "text",
                  "text": nameIdInput.value,
                  "size": "xs",
                  "color": "#111111",
                  "align": "end",
                  "flex": 2,
                  "weight": "bold"
                }
              ],
              "margin": "sm"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "เบอร์โทรศัพท์",
                  "size": "sm",
                  "color": "#555555",
                  "flex": 1
                },
                {
                  "type": "text",
                  "text": formattedPhone,
                  "size": "xs",
                  "color": "#111111",
                  "align": "end",
                  "flex": 2,
                  "weight": "bold"
                }
              ],
              "margin": "sm"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "รายละเอียด",
                  "size": "sm",
                  "color": "#555555",
                  "flex": 1
                },
                {
                  "type": "text",
                  "text": keynumber2IdInput.value || '-',
                  "size": "xs",
                  "color": "#111111",
                  "align": "end",
                  "flex": 3,
                  "wrap": true,
                  "weight": "bold"
                }
              ],
              "margin": "sm"
            }
          ],
          "paddingBottom": "xl"
        },
        "footer": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "ขอบคุณที่ใช้บริการ MWA",
              "size": "xs",
              "color": "#aaaaaa",
              "align": "center"
            }
          ],
          "backgroundColor": "#ffffff"
        },
        "styles": {
          "footer": {
            "separator": true
          }
        }
      }
    };

    try {
        await liff.sendMessages([flexMessage]);
        console.log("Flex message sent");
    } catch (error) {
        console.error("Error sending flex message:", error); 
    }
}

function getBase64(file) {
    return new Promise((resolve, reject) => {
        let reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

function previewImage() {
    if (fileInput.files.length > 0) {
        let file = fileInput.files[0];
        let reader = new FileReader();
        reader.onload = function(e) {
            imgPreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        imgPreview.src = currentProfileImage;
    }
}

fileInput.addEventListener('change', () => {
    previewImage();
});

function validateForm() {
    const userlineId = userlineIdInput.value.trim();
    const nameId = nameIdInput.value.trim();
    const keynumberId = keynumberIdInput.value.trim();
    const keynumber3Id = keynumber3IdInput.value.trim();
    const keynumber2Id = keynumber2IdInput.value.trim();

    if (userlineId === '' || nameId === '' || keynumberId === '' || keynumber3Id === '' || keynumber2Id === '') {
        return false;
    }
    return true;
}

async function showConfirmationDialog() {
    const confirmation = await Swal.fire({
        title: 'ยืนยันการส่งข้อมูล',
        text: 'ตรวจสอบความถูกต้องก่อนส่งข้อมูล?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'แก้ไข',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33'
    });
    return confirmation.isConfirmed;
}

submitBtn.addEventListener('click', async (event) => {
    event.preventDefault();

    // 1. ตรวจสอบ Input ทั่วไป
    if (!validateForm()) {
        Swal.fire({
            icon: 'warning',
            title: 'ข้อมูลไม่ครบถ้วน',
            text: 'กรุณากรอกข้อมูลในช่องที่มีเครื่องหมาย * ให้ครบ',
        });
        return;
    }

    // 2.ตรวจสอบว่ามีการเลือกหัวข้อแล้ว
    const keynumber3Val = keynumber3IdInput.value.trim();
    if (keynumber3Val === '') {
        Swal.fire({
            icon: 'warning',
            title: 'ข้อมูลไม่ถูกต้อง',
            text: 'กรุณาเลือกหัวข้อปัญหาที่ต้องการแจ้ง',
        });
        return;
    }

    const keynumberVal = keynumberIdInput.value.trim();
    if (!/^0\d{9}$/.test(keynumberVal)) {
        Swal.fire({
            icon: 'warning',
            title: 'เบอร์โทรศัพท์ไม่ถูกต้อง',
            text: 'กรุณากรอกเบอร์โทรศัพท์ 10 หลัก ให้ถูกต้อง (ตัวเลขเท่านั้นและขึ้นต้นด้วย 0)',
        });
        return;
    }
    
    const isConfirmed = await showConfirmationDialog();

    if (isConfirmed) {
        submitBtn.disabled = true;
        loadingText.innerText = "กำลังบันทึกข้อมูล...";
        loadingOverlay.style.display = 'flex';      

        try {
            let obj;             
            // Common properties for both cases
            const commonProps = {
                userlineId: userlineIdInput.value,
                nameId: nameIdInput.value,
                keynumberId: keynumberIdInput.value,
                keynumber2Id: keynumber2IdInput.value,
                keynumber3Id: keynumber3IdInput.value,
                // **สำคัญ**: ลบ Checkbox ออกจาก UI และ hardcode ค่าเป็น false เพื่อให้โค้ดฝั่ง server ไม่พัง
                keynumber4Id: false, // e-Bill
                keynumber5Id: false  // e-Tax
            };

            if (fileInput.files.length > 0) {               
                let file = fileInput.files[0];
                let base64 = await getBase64(file);
                imgPreview.src = `data:${file.type};base64,${base64}`;

                obj = {
                    base64: base64,
                    type: file.type,
                    name: file.name,
                    ...commonProps
                };
            } else {
                let imageUrlToFetch = currentProfileImage;
                let imageName = "Profile.jpg";
                
                try {
                    let response = await fetch(imageUrlToFetch);
                    let blob = await response.blob();
                    let base64 = await getBase64(blob);
                    
                    obj = {
                        base64: base64,
                        type: blob.type,
                        name: imageName,
                        ...commonProps
                    };
                } catch (corsError) {
                    console.warn("Cannot fetch Profile Image, using Default Avatar.");
                    let response = await fetch(DEFAULT_AVATAR);
                    let blob = await response.blob();
                    let base64 = await getBase64(blob);

                    obj = {
                        base64: base64,
                        type: "image/png",
                        name: "Avatar.png",
                        ...commonProps
                    };
                }
            }

            let response = await fetch(url, {
                method: "POST",
                body: JSON.stringify(obj)
            });

            await response.text(); 
            await sendFlexMessage();

            loadingOverlay.style.display = 'none';  

            await Swal.fire({
                title: 'สำเร็จ!',
                text: 'ส่งข้อมูลแจ้งเหตุเรียบร้อย',
                icon: 'success',
                confirmButtonText: 'ปิดหน้าต่าง',
                allowOutsideClick: false
            });

            liff.closeWindow();

        } catch (error) {
            loadingOverlay.style.display = 'none';
            console.error(error);
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถส่งข้อมูลได้ กรุณาลองใหม่ภายหลัง',
            });
            submitBtn.disabled = false;
        } 
  }
});
</script>
</body>
</html>
