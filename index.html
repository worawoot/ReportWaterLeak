<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบแจ้งเหตุ MWA</title>
    
    <!-- CSS & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .input-field { @apply w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500 transition; }
        .section-label { @apply block text-sm font-semibold text-gray-700 mb-1; }
        #map { height: 250px; width: 100%; border-radius: 0.5rem; z-index: 1; }
        
        /* Custom Upload Box */
        .upload-box {
            border: 2px dashed #d1d5db;
            background-color: #f9fafb;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .upload-box:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .upload-box img { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>

<!-- Loading -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-3"></div>
    <span class="text-blue-600 font-medium">กำลังดำเนินการ...</span>
</div>

<!-- Main Container -->
<div class="max-w-md mx-auto bg-white min-h-screen shadow-lg sm:my-4 sm:rounded-xl overflow-hidden relative">
    
    <!-- Header -->
    <div class="bg-white p-4 border-b flex items-center justify-between sticky top-0 z-50 shadow-sm">
        <h1 class="text-lg font-bold text-gray-800">ระบบแจ้งเหตุท่อประปาแตกรั่ว/เรื่องร้องเรียน</h1>
        <button onclick="window.location.reload()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-rotate-right"></i></button>
    </div>

    <form id="reportForm" class="p-4 space-y-5 pb-20">
        
        <input type="hidden" id="userlineId">
        <input type="hidden" id="coordinates">

        <!-- 1. หัวข้อ -->
        <div>
            <label class="section-label">หัวข้อ <span class="text-red-500">*</span></label>
            <select id="topic" class="input-field bg-gray-50">
                <option value="" disabled selected>เลือกหัวข้อ</option>
                <option value="ท่อแตกรั่ว">ท่อแตกรั่ว</option>
                <option value="น้ำไม่ไหล/ไหลอ่อน">น้ำไม่ไหล/ไหลอ่อน</option>
                <option value="น้ำมีกลิ่น/ขุ่น">น้ำมีกลิ่น/ขุ่น</option>
                <option value="มิเตอร์หาย/ชำรุด">มิเตอร์หาย/ชำรุด</option>
                <option value="อื่นๆ">อื่นๆ</option>
            </select>
        </div>

        <!-- 2. รายละเอียด -->
        <div>
            <label class="section-label">รายละเอียด</label>
            <textarea id="detail" rows="4" class="input-field bg-gray-50 resize-none" placeholder="รายละเอียด..."></textarea>
        </div>

        <!-- 3. ภาพปัญหา -->
        <div>
            <label class="section-label">ภาพปัญหา <span class="text-red-500">*</span></label>
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <img id="previewImage" class="hidden">
                <div id="uploadPlaceholder" class="text-center text-gray-400">
                    <i class="fa-regular fa-image text-4xl mb-2"></i>
                    <p class="text-sm">แตะเพื่อถ่ายรูป/อัพโหลด</p>
                </div>
            </div>
            <input type="file" id="fileInput" accept="image/*" class="hidden" capture="environment">
        </div>

        <!-- 4. ตำแหน่ง (Map) -->
        <div>
            <label class="section-label">ตำแหน่ง <span class="text-red-500">*</span></label>
            <div class="relative">
                <div id="map"></div>
                <button type="button" onclick="getCurrentLocation()" class="absolute top-2 right-2 bg-white p-2 rounded shadow text-blue-600 hover:text-blue-800 z-[400]">
                    <i class="fa-solid fa-location-crosshairs text-xl"></i>
                </button>
            </div>
            <p id="latlongText" class="text-xs text-gray-400 mt-1">กรุณากดปุ่มพิกัด หรือเลื่อนหมุดเพื่อระบุตำแหน่ง</p>
        </div>

        <!-- 5. ผู้แจ้ง -->
        <div>
            <label class="section-label">ผู้แจ้ง</label>
            <input type="text" id="name" class="input-field" placeholder="ชื่อผู้แจ้ง">
        </div>

        <!-- 6. เบอร์โทรศัพท์ -->
        <div>
            <label class="section-label">เบอร์โทรศัพท์ <span class="text-red-500">*</span></label>
            <input type="tel" id="phone" class="input-field" placeholder="เบอร์โทรศัพท์..." maxlength="10">
        </div>

    </form>

    <!-- Footer Button -->
    <div class="fixed bottom-0 left-0 w-full bg-white p-4 border-t shadow-lg sm:absolute">
        <button id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-md">
            ส่งข้อความ
        </button>
    </div>
</div>

<!-- LIFF & Scripts -->
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
    // Config
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby1KI1Av9dntREN3hb86QRAKUWSZeB7HrexeCeiIbwcczTxFbk11is-wqvbEWdLX84L/exec'; 
    const LIFF_ID = '1657790891-40VQpd6O'; 

    // Elements
    const fileInput = document.getElementById('fileInput');
    const previewImage = document.getElementById('previewImage');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Map Variables
    let map, marker;
    let currentLat = 13.7563; // Default Bangkok
    let currentLng = 100.5018;

    // --- INIT ---
    window.onload = async function() {
        initMap();
        await initLiff();
    };

    // --- MAP LOGIC ---
    function initMap() {
        map = L.map('map').setView([currentLat, currentLng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // Marker (Draggable)
        marker = L.marker([currentLat, currentLng], {draggable: true}).addTo(map);
        
        // Update input on drag
        marker.on('dragend', function(event) {
            var position = marker.getLatLng();
            updateCoordinates(position.lat, position.lng);
        });

        // Try auto-locate on load
        getCurrentLocation();
    }

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                map.setView([lat, lng], 16);
                marker.setLatLng([lat, lng]);
                updateCoordinates(lat, lng);
            }, () => {
                // Error handled silently, default map stays
            });
        }
    }

    function updateCoordinates(lat, lng) {
        document.getElementById('coordinates').value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
        document.getElementById('latlongText').innerText = `พิกัด: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }

    // --- LIFF LOGIC ---
    async function initLiff() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('userlineId').value = profile.userId;
                // Auto fill name if available
                if(!document.getElementById('name').value) {
                    document.getElementById('name').value = profile.displayName;
                }
            } else {
                liff.login();
            }
        } catch (err) {
            console.error(err);
        }
    }

    // --- IMAGE LOGIC ---
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
            }
            reader.readAsDataURL(file);
        }
    });

    function getBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
    }

    // --- SUBMIT ---
    document.getElementById('submitBtn').addEventListener('click', async (e) => {
        e.preventDefault();

        // Validation
        const topic = document.getElementById('topic').value;
        const phone = document.getElementById('phone').value;
        const coords = document.getElementById('coordinates').value;
        const hasImage = !previewImage.classList.contains('hidden');

        if (!topic || !phone || !coords || !hasImage) {
            Swal.fire({
                icon: 'warning',
                title: 'ข้อมูลไม่ครบ',
                text: 'กรุณากรอกข้อมูลที่มี * ให้ครบถ้วน (รวมถึงรูปภาพและพิกัด)',
                confirmButtonColor: '#2563EB'
            });
            return;
        }

        // Confirm
        const result = await Swal.fire({
            title: 'ยืนยันการแจ้งเหตุ',
            text: 'ตรวจสอบข้อมูลถูกต้องแล้ว?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ยืนยัน ส่งข้อมูล',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#2563EB'
        });

        if (result.isConfirmed) {
            loadingOverlay.style.display = 'flex';

            try {
                const file = fileInput.files[0];
                const base64 = await getBase64(file);

                const payload = {
                    userlineId: document.getElementById('userlineId').value,
                    topic: topic,
                    detail: document.getElementById('detail').value,
                    coordinates: coords,
                    name: document.getElementById('name').value,
                    phone: phone,
                    base64: base64,
                    fileName: file.name || 'image.png'
                };

                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                loadingOverlay.style.display = 'none';
                
                await Swal.fire({
                    icon: 'success',
                    title: 'ส่งข้อมูลสำเร็จ',
                    text: 'เจ้าหน้าที่ได้รับเรื่องแล้ว',
                    confirmButtonText: 'ปิด',
                    confirmButtonColor: '#2563EB'
                });

                if (liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.location.reload();
                }

            } catch (error) {
                console.error(error);
                loadingOverlay.style.display = 'none';
                Swal.fire('Error', 'เกิดข้อผิดพลาดในการส่งข้อมูล', 'error');
            }
        }
    });
</script>

</body>
</html>
