<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แจ้งเหตุน้ำประปา/ท่อแตกรั่ว</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
    body {
        font-family: 'IBM Plex Sans Thai', sans-serif !important;
        font-weight: 600 !important;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    /* Map Container Height */
    #map {
        height: 300px;
        width: 100%;
        z-index: 1; /* Ensure map is below overlays */
    }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

<div id="loadingOverlay" class="loading-overlay">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
    <p id="loadingText" class="text-gray-600 font-semibold">กรุณารอสักครู่...</p>
</div>
    
<div class="max-w-md m-auto p-2">
    <form>
        <div class="bg-white rounded-lg p-6 sm:p-10 shadow-md"> 

            <!-- Header -->
            <div class="text-center mb-4">
                <div class="flex items-center justify-center space-x-3 mb-1">
                    <img src="https://firebasestorage.googleapis.com/v0/b/webapp-c8c38.appspot.com/o/th-full-white.png?alt=media&token=88a41cdb-27fd-4c98-8d11-a390ef103163" 
                         alt="MWA Logo" 
                         onerror="this.onerror=null;this.src='https://placehold.co/48x48/007bff/ffffff?text=MWA'"
                         class="h-12 w-auto object-contain">
                    <h1 class="text-xl sm:text-2xl font-bold text-blue-600">แจ้งเหตุประปาขัดข้อง</h1> 
                </div>
                <p class="text-sm text-gray-500 font-medium">การประปานครหลวง (สาขาลาดพร้าว)</p>
            </div>
            
            <!-- Image Upload -->
            <div class="mb-5 text-center">
                <div class="relative mx-auto w-full h-56 mb-4 group">
                    <img src="https://drive.google.com/thumbnail?id=17Ejxsa6GFTFrpoKFkoXna-KudkgmPwHW" 
                         alt="Problem Image" 
                         id="preview" 
                         class="w-full h-56 object-cover rounded-2xl border-4 border-white shadow-lg mx-auto bg-slate-50">                       
                    
                    <label for="file" class="absolute -bottom-2 -right-2 bg-white p-2.5 rounded-full shadow-md cursor-pointer hover:bg-blue-50 hover:text-blue-600 transition-all duration-200 border border-slate-200 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600 hover:text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <input type="file" id="file" name="file" accept="image/*" class="hidden">
                    </label>
                </div>
                <div id="displayName" class="text-xl text-slate-700 font-bold mt-2 hidden"></div>                    
                <p class="text-xs text-slate-400 mt-1">แตะไอคอนกล้องเพื่อถ่ายรูปจุดเกิดเหตุ <span class="text-red-500">*</span></p>
            </div>
            
            <div class="flex flex-col space-y-4">              
                <input type="text" class="hidden" id="userlineId" name="userlineId" readonly>

                <!-- MAP SECTION -->
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ตำแหน่งที่ตั้ง (ระบุพิกัด) <span class="text-red-500">*</span></label>
                    
                    <!-- Map Container -->
                    <div id="map" class="rounded-lg shadow-sm border border-gray-300 mb-3"></div>
                    
                    <button type="button" onclick="getLocation(false)" class="bg-white text-blue-600 hover:bg-blue-50 border border-blue-200 w-full py-2 rounded-lg text-sm font-bold flex items-center justify-center transition shadow-sm mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        ค้นหาตำแหน่งปัจจุบันของฉัน
                    </button>

                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="latitude" name="latitude" placeholder="ละติจูด" readonly 
                            class="bg-gray-100 border border-gray-200 text-gray-500 text-xs rounded px-2 py-1">
                        <input type="text" id="longitude" name="longitude" placeholder="ลองจิจูด" readonly 
                            class="bg-gray-100 border border-gray-200 text-gray-500 text-xs rounded px-2 py-1">
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1 text-center">* สามารถลากหมุดสีน้ำเงินในแผนที่เพื่อปรับตำแหน่งได้</p>
                </div>

                <div>
                    <label for="keynumber3Id" class="block text-sm font-semibold text-gray-700 mb-1">หัวข้อปัญหา <span class="text-red-500">*</span></label>
                    <select id="keynumber3Id" name="keynumber3Id" required
                        class="w-full border border-gray-300 p-2.5 text-sm rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="" disabled selected>-- กรุณาเลือก --</option>
                        <option value="ท่อประปาแตกรั่ว">ท่อประปาแตกรั่ว</option>
                        <option value="น้ำไม่ไหล/ไหลอ่อน">น้ำไม่ไหล/ไหลอ่อน</option>
                        <option value="น้ำขุ่น/มีกลิ่น">น้ำขุ่น/มีกลิ่น</option>
                        <option value="ค่าน้ำ/มาตรวัดน้ำ">ค่าน้ำ/มาตรวัดน้ำ</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>

                <div>
                    <label for="nameId" class="block text-sm font-semibold text-gray-700 mb-1">ชื่อผู้แจ้ง <span class="text-red-500">*</span></label>
                    <input type="text" class="w-full border border-gray-300 p-2.5 text-sm rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="nameId" placeholder="ชื่อ-นามสกุล" name="nameId" required>
                </div>
                    
                <div>
                    <label for="keynumberId" class="block text-sm font-semibold text-gray-700 mb-1">เบอร์โทรศัพท์ <span class="text-red-500">*</span></label>                    
                    <input type="tel" class="w-full border border-gray-300 p-2.5 text-sm rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="keynumberId" placeholder="08xxxxxxxx" maxlength="10" inputmode="numeric" required>
                </div>
                    
                <div class="mb-2">
                    <label for="keynumber2Id" class="block text-sm font-semibold text-gray-700 mb-1">รายละเอียดเพิ่มเติม <span class="text-red-500">*</span></label>
                    <textarea 
                        class="w-full border border-gray-300 p-2.5 text-sm rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        id="keynumber2Id" 
                        name="keynumber2Id" 
                        rows="3"
                        required
                        placeholder="จุดสังเกต หรือรายละเอียดความเสียหาย"></textarea>
                </div>

                <!-- Hidden e-Bill/e-Tax Checkboxes (Default Checked) -->
                <div class="hidden">
                    <input type="checkbox" id="keynumber4Id" name="keynumber4Id" checked>
                    <input type="checkbox" id="keynumber5Id" name="keynumber5Id" checked>
                </div>
            </div>

            <button type="button" id="submitBtn" class="mt-6 bg-gradient-to-r from-blue-500 to-blue-600 text-white w-full py-3.5 px-4 rounded-xl font-bold hover:from-blue-600 hover:to-blue-700 shadow-lg transform active:scale-95 transition-all">
                ส่งแจ้งเหตุ
            </button>
            
            <footer class="text-center text-xs text-gray-400 mt-6 font-light">
                MWA Reporting System © 2025
            </footer>
        </div>           
    </form>
</div>

<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz9oiEei5V9ZYvcVPgzq_v1WWafS0YOclXh21MXlDZqsGQ0_WDrwxJq9YlEhvblZCr1RQ/exec'; 
const LIFF_ID = '1657790891-40VQpd6O';
const DEFAULT_AVATAR = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";

// รูป Default กรณีที่ไม่มีการอัปโหลดรูป หรือดึงรูปไม่สำเร็จ
const DEFAULT_HERO_IMAGE = 'https://cdn.pixabay.com/photo/2014/06/04/16/36/manhole-cover-362150_960_720.jpg';

let fileInput = document.getElementById("file");
let imgPreview = document.getElementById("preview");
let userlineIdInput = document.getElementById("userlineId");
let nameIdInput = document.getElementById("nameId");
let keynumberIdInput = document.getElementById("keynumberId");
let keynumber2IdInput = document.getElementById("keynumber2Id");
let submitBtn = document.getElementById("submitBtn");
let keynumber3IdInput = document.getElementById("keynumber3Id");
let keynumber4IdInput = document.getElementById("keynumber4Id");
let keynumber5IdInput = document.getElementById("keynumber5Id");
let latitudeInput = document.getElementById("latitude");
let longitudeInput = document.getElementById("longitude");

const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');

let currentProfileImage = DEFAULT_AVATAR;
let map, marker;

window.onload = function () {
    loadingText.innerText = "กำลังโหลด...";
    loadingOverlay.style.display = 'flex';
    
    initializeMap(); 
    initializeLiff();
    
    // Auto call location on load (Silent Mode)
    getLocation(true); 
};

// --- MAP FUNCTIONS ---
function initializeMap() {
    const defaultLat = 13.7563;
    const defaultLng = 100.5018;

    map = L.map('map').setView([defaultLat, defaultLng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    marker = L.marker([defaultLat, defaultLng], {draggable: true}).addTo(map);

    marker.on('dragend', function(e) {
        const position = marker.getLatLng();
        updateLocationInputs(position.lat, position.lng);
    });

    map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        updateLocationInputs(e.latlng.lat, e.latlng.lng);
    });
}

function getLocation(isAuto = false) {
    if (!isAuto) {
        Swal.fire({
            title: 'กำลังค้นหาตำแหน่ง...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => showPosition(position, isAuto), 
            (error) => showError(error, isAuto), 
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    } else {
        if (!isAuto) {
            Swal.close();
            Swal.fire('Error', 'เบราว์เซอร์ไม่รองรับ Geolocation', 'error');
        }
    }
}

function showPosition(position, isAuto) {
    if (!isAuto) Swal.close();
    
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    map.setView([lat, lng], 17);
    marker.setLatLng([lat, lng]);
    updateLocationInputs(lat, lng);

    if (!isAuto) {
        Swal.fire({
            icon: 'success',
            title: 'ระบุตำแหน่งสำเร็จ',
            timer: 1500,
            showConfirmButton: false
        });
    }
}

function updateLocationInputs(lat, lng) {
    latitudeInput.value = lat.toFixed(6);
    longitudeInput.value = lng.toFixed(6);
}

function showError(error, isAuto) {
    if (isAuto) return; 

    Swal.close();
    let msg = "ไม่สามารถระบุตำแหน่งได้";
    if (error.code === error.PERMISSION_DENIED) msg = "กรุณากด 'อนุญาต' ให้เข้าถึงตำแหน่ง";
    Swal.fire('ข้อผิดพลาด', msg, 'warning');
}
// ---------------------

async function initializeLiff() {
    try {
        await liff.init({ liffId: LIFF_ID });
        if (liff.isLoggedIn()) {
            await getUserProfile();
        } else {
            liff.login();
        }
    } catch (err) {
        console.error('LIFF Init failed', err);
        loadingOverlay.style.display = 'none';
    }
}

async function getUserProfile() {
    try {
        const profile = await liff.getProfile();
        userlineIdInput.value = profile.userId;
        document.getElementById('displayName').innerText = profile.displayName;
    } catch (error) {
        console.error('Profile Error:', error);
    } finally {
        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
    }
}

// --- UPDATED FLEX MESSAGE FUNCTION ---
// รับ Parameter uploadedImageUrl มาแสดงผล
async function sendFlexMessage(uploadedImageUrl) {
    if (!liff.isInClient()) return;

    let formattedPhone = keynumberIdInput.value.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
    let lat = latitudeInput.value;
    let long = longitudeInput.value;
    let mapLink = `https://www.google.com/maps/search/?api=1&query=${lat},${long}`;
    let currentDate = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit'});

    // เลือกใช้รูปที่อัปโหลด ถ้าไม่มีให้ใช้รูป Default
    let displayImage = uploadedImageUrl && uploadedImageUrl !== "" ? uploadedImageUrl : DEFAULT_HERO_IMAGE;

    const flexMessage = {
        "type": "flex",
        "altText": "แจ้งเหตุประปาขัดข้องสำเร็จ",
        "contents": {
            "type": "bubble",
            "size": "giga",
            "hero": {
                "type": "image",
                "url": displayImage, // *** ใช้ตัวแปรนี้แทน ***
                "size": "full",
                "aspectRatio": "20:13",
                "aspectMode": "cover",
                "action": {
                    "type": "uri",
                    "uri": mapLink
                }
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": "รับแจ้งเหตุเรียบร้อย",
                        "weight": "bold",
                        "size": "xl",
                        "color": "#0056b3"
                    },
                    {
                        "type": "text",
                        "text": `วันที่: ${currentDate}`,
                        "size": "xs",
                        "color": "#aaaaaa",
                        "margin": "sm"
                    },
                    {
                        "type": "separator",
                        "margin": "lg"
                    },
                    {
                        "type": "box",
                        "layout": "vertical",
                        "margin": "lg",
                        "spacing": "sm",
                        "contents": [
                            {
                                "type": "box",
                                "layout": "baseline",
                                "spacing": "sm",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "หัวข้อ",
                                        "color": "#aaaaaa",
                                        "size": "sm",
                                        "flex": 2
                                    },
                                    {
                                        "type": "text",
                                        "text": keynumber3IdInput.value,
                                        "wrap": true,
                                        "color": "#666666",
                                        "size": "sm",
                                        "flex": 5,
                                        "weight": "bold"
                                    }
                                ]
                            },
                            {
                                "type": "box",
                                "layout": "baseline",
                                "spacing": "sm",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "ผู้แจ้ง",
                                        "color": "#aaaaaa",
                                        "size": "sm",
                                        "flex": 2
                                    },
                                    {
                                        "type": "text",
                                        "text": nameIdInput.value,
                                        "wrap": true,
                                        "color": "#666666",
                                        "size": "sm",
                                        "flex": 5
                                    }
                                ]
                            },
                            {
                                "type": "box",
                                "layout": "baseline",
                                "spacing": "sm",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "เบอร์โทร",
                                        "color": "#aaaaaa",
                                        "size": "sm",
                                        "flex": 2
                                    },
                                    {
                                        "type": "text",
                                        "text": formattedPhone,
                                        "wrap": true,
                                        "color": "#666666",
                                        "size": "sm",
                                        "flex": 5
                                    }
                                ]
                            },
                            {
                                "type": "box",
                                "layout": "baseline",
                                "spacing": "sm",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "พิกัด",
                                        "color": "#aaaaaa",
                                        "size": "sm",
                                        "flex": 2
                                    },
                                    {
                                        "type": "text",
                                        "text": `${lat}, ${long}`,
                                        "wrap": true,
                                        "color": "#666666",
                                        "size": "xs",
                                        "flex": 5
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "type": "box",
                        "layout": "vertical",
                        "margin": "lg",
                        "contents": [
                            {
                                "type": "text",
                                "text": "รายละเอียดเพิ่มเติม:",
                                "size": "xs",
                                "color": "#aaaaaa",
                                "margin": "none"
                            },
                            {
                                "type": "text",
                                "text": keynumber2IdInput.value,
                                "wrap": true,
                                "color": "#333333",
                                "size": "sm",
                                "margin": "sm"
                            }
                        ]
                    }
                ]
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "spacing": "sm",
                "contents": [
                    {
                        "type": "button",
                        "style": "primary",
                        "height": "sm",
                        "action": {
                            "type": "uri",
                            "label": "ดูตำแหน่งใน Google Map",
                            "uri": mapLink
                        },
                        "color": "#0056b3"
                    },
                    {
                        "type": "button",
                        "style": "link",
                        "height": "sm",
                        "action": {
                            "type": "uri",
                            "label": "โทรสายด่วน 1125",
                            "uri": "tel:1125"
                        }
                    },
                    {
                        "type": "spacer",
                        "size": "sm"
                    }
                ],
                "flex": 0
            }
        }
    };

    try {
        await liff.sendMessages([flexMessage]);
    } catch (error) { console.error("LIFF Send Error:", error); }
}

function getBase64(file) {
    return new Promise((resolve, reject) => {
        let reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        let file = fileInput.files[0];
        let reader = new FileReader();
        reader.onload = function(e) { imgPreview.src = e.target.result; };
        reader.readAsDataURL(file);
    }
});

function validateForm() {
    if (!userlineIdInput.value || !nameIdInput.value || !keynumberIdInput.value || !keynumber3IdInput.value || !keynumber2IdInput.value) {
        return { valid: false, msg: 'กรุณากรอกข้อมูลที่มีเครื่องหมาย * ให้ครบ' };
    }
    if (!latitudeInput.value || !longitudeInput.value) {
        return { valid: false, msg: 'กรุณาระบุตำแหน่งในแผนที่' };
    }
    return { valid: true };
}

submitBtn.addEventListener('click', async (event) => {
    event.preventDefault();

    const val = validateForm();
    if (!val.valid) {
        Swal.fire({ icon: 'warning', title: 'ข้อมูลไม่ครบถ้วน', text: val.msg });
        return;
    }

    const isConfirmed = await Swal.fire({
        title: 'ยืนยันการแจ้งเหตุ',
        text: 'ตรวจสอบข้อมูลถูกต้องแล้วใช่หรือไม่?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'แก้ไข'
    });

    if (isConfirmed.isConfirmed) {
        submitBtn.disabled = true;
        loadingText.innerText = "กำลังส่งข้อมูล...";
        loadingOverlay.style.display = 'flex';       

        try {
            let base64 = "";
            let fileName = "NoImage";
            let fileType = "";

            if (fileInput.files.length > 0) {
                let file = fileInput.files[0];
                base64 = await getBase64(file);
                fileName = file.name;
                fileType = file.type;
            }

            let obj = {
                userlineId: userlineIdInput.value,
                nameId: nameIdInput.value,
                keynumberId: keynumberIdInput.value,
                keynumber2Id: keynumber2IdInput.value,
                keynumber3Id: keynumber3IdInput.value,
                keynumber4Id: keynumber4IdInput.checked,
                keynumber5Id: keynumber5IdInput.checked,
                latitude: latitudeInput.value,
                longitude: longitudeInput.value,
                base64: base64,
                name: fileName,
                type: fileType
            };

            // Call Web App
            const response = await fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify(obj)
            });

            // *** รับค่า JSON กลับมาจาก Google Apps Script ***
            const data = await response.json(); 
            
            // ดึง URL จาก Response ถ้าไม่มีก็ส่งค่าว่างไป
            let uploadedImageUrl = data.imageUrl || "";

            // ส่ง URL รูปไปให้ฟังก์ชันสร้าง Flex Message
            await sendFlexMessage(uploadedImageUrl);
            
            loadingOverlay.style.display = 'none';
            await Swal.fire('สำเร็จ', 'ส่งข้อมูลเรียบร้อยแล้ว', 'success');
            liff.closeWindow();

        } catch (error) {
            loadingOverlay.style.display = 'none';
            console.error(error);
            Swal.fire('Error', 'เกิดข้อผิดพลาดในการส่งข้อมูล', 'error');
            submitBtn.disabled = false;
        } 
    }
});
</script>
</body>
</html>
