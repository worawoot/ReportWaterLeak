<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏õ‡∏≤ MWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-blue-50 min-h-screen pb-10">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <p id="loadingText" class="text-blue-800 font-semibold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</p>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl p-6 shadow-xl border border-blue-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>

            <!-- Header -->
            <div class="text-center mb-6 mt-2">
                <h1 class="text-2xl font-bold text-gray-800">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</h1>
                <p class="text-gray-500 text-sm">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡∏ô‡∏Ñ‡∏£‡∏´‡∏•‡∏ß‡∏á</p>
            </div>

            <form id="reportForm" onsubmit="return false;">
                
                <input type="hidden" id="userlineId" name="userlineId">

                <!-- 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á -->
                <div class="mb-5">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á <span class="text-red-500">*</span></label>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border rounded-xl cursor-pointer hover:bg-blue-50 transition peer-checked:border-blue-500 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                            <input type="radio" name="issueType" value="‡∏ó‡πà‡∏≠‡πÅ‡∏ï‡∏Å‡∏£‡∏±‡πà‡∏ß" class="w-4 h-4 text-blue-600 focus:ring-blue-500" checked>
                            <span class="ml-3 font-medium text-gray-700">üí¶ ‡∏ó‡πà‡∏≠‡πÅ‡∏ï‡∏Å‡∏£‡∏±‡πà‡∏ß</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-xl cursor-pointer hover:bg-blue-50 transition peer-checked:border-blue-500 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                            <input type="radio" name="issueType" value="‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•/‡πÑ‡∏´‡∏•‡∏≠‡πà‡∏≠‡∏ô" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                            <span class="ml-3 font-medium text-gray-700">üöø ‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏• / ‡πÑ‡∏´‡∏•‡∏≠‡πà‡∏≠‡∏ô</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-xl cursor-pointer hover:bg-blue-50 transition peer-checked:border-blue-500 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                            <input type="radio" name="issueType" value="‡∏ô‡πâ‡∏≥‡∏Ç‡∏∏‡πà‡∏ô/‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                            <span class="ml-3 font-medium text-gray-700">ü¶† ‡∏ô‡πâ‡∏≥‡∏Ç‡∏∏‡πà‡∏ô / ‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô</span>
                        </label>
                    </div>
                </div>

                <!-- 2. ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á <span class="text-red-500">*</span></label>
                    <input type="text" id="reporterName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                </div>

                <!-- 3. ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-500">*</span></label>
                    <input type="tel" id="phoneNumber" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="08xxxxxxxx" maxlength="10">
                </div>

                <!-- 4. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="details" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï, ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö"></textarea>
                </div>

                <!-- 5. ‡∏û‡∏¥‡∏Å‡∏±‡∏î (GPS) -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ <span class="text-red-500">*</span></label>
                    <div class="flex gap-2">
                        <input type="text" id="coordinates" class="w-full px-4 py-2 border rounded-lg bg-gray-100 text-gray-500 text-sm" readonly placeholder="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î">
                        <button type="button" onclick="getLocation()" class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 transition text-sm font-semibold whitespace-nowrap">
                            üìç ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î
                        </button>
                    </div>
                    <div id="mapPreview" class="mt-2 hidden rounded-lg overflow-hidden border border-gray-300 h-32">
                        <!-- Map iframe will be injected here -->
                    </div>
                </div>

                <!-- 6. ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô <span class="text-red-500">*</span></label>
                    <div class="relative w-full h-48 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 flex flex-col justify-center items-center cursor-pointer hover:bg-gray-100 transition overflow-hidden" onclick="document.getElementById('fileInput').click()">
                        <div id="uploadPlaceholder" class="text-center p-4">
                            <svg class="w-10 h-10 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span class="text-sm text-gray-500">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span>
                        </div>
                        <img id="imagePreview" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="previewImage(this)">
                </div>

                <button type="button" onclick="submitForm()" id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-blue-700 hover:shadow-xl transition transform active:scale-95">
                    ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </button>

            </form>
        </div>
        <p class="text-center text-xs text-gray-400 mt-6">MWA Pipe Leak Reporting System</p>
    </div>

    <script>
        // *** ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ***
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzKKmAmPlOXxSeALUDe3fr3YLBYXCwEwfNoJbJelKUeg-kvQcQpID7M0qPHVXIN0aUc/exec'; // ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á Deploy
        const LIFF_ID = '1657790891-40VQpd6O'; 

        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    document.getElementById('userlineId').value = profile.userId;
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF Init failed", err);
            }
        }
        window.onload = initLiff;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Preview ‡∏£‡∏π‡∏õ
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
        function getLocation() {
            const coordInput = document.getElementById('coordinates');
            const mapDiv = document.getElementById('mapPreview');
            
            coordInput.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    const coords = `${lat},${lng}`;
                    
                    coordInput.value = coords;
                    mapDiv.classList.remove('hidden');
                    mapDiv.innerHTML = `<iframe width="100%" height="100%" frameborder="0" style="border:0" src="https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed"></iframe>`;
                }, (error) => {
                    coordInput.value = "";
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS', 'error');
                });
            } else {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation', 'error');
            }
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                let reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function submitForm() {
            const issueType = document.querySelector('input[name="issueType"]:checked').value;
            const reporterName = document.getElementById('reporterName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const details = document.getElementById('details').value;
            const coordinates = document.getElementById('coordinates').value;
            const fileInput = document.getElementById('fileInput');
            const userlineId = document.getElementById('userlineId').value;

            // Validation
            if (!reporterName || !phoneNumber || !coordinates || coordinates.includes("‡∏Å‡∏≥‡∏•‡∏±‡∏á") || fileInput.files.length === 0) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ * ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢)', 'warning');
                return;
            }

            const confirm = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ "${issueType}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                confirmButtonColor: '#2563EB'
            });

            if (confirm.isConfirmed) {
                const overlay = document.getElementById('loadingOverlay');
                overlay.style.display = 'flex';
                document.getElementById('submitBtn').disabled = true;

                try {
                    const base64 = await getBase64(fileInput.files[0]);
                    
                    const payload = {
                        action: 'submitReport',
                        userlineId: userlineId,
                        issueType: issueType,
                        reporterName: reporterName,
                        phoneNumber: phoneNumber,
                        details: details,
                        coordinates: coordinates,
                        imageName: fileInput.files[0].name,
                        imageMime: fileInput.files[0].type,
                        imageBase64: base64
                    };

                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });

                    overlay.style.display = 'none';
                    await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    liff.closeWindow();

                } catch (error) {
                    console.error(error);
                    overlay.style.display = 'none';
                    document.getElementById('submitBtn').disabled = false;
                    Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }
    </script>
</body>
</html>
