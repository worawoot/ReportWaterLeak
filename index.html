<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏õ‡∏≤ MWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Kanit', sans-serif !important;
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .map-preview {
            width: 100%; height: 200px; background-color: #f1f5f9;
            border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;
            color: #64748b; font-size: 0.875rem; border: 2px dashed #cbd5e1;
            margin-top: 0.5rem; overflow: hidden;
        }
    </style>
</head>
<body class="bg-blue-50 min-h-screen">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <p id="loadingText" class="text-blue-800 font-semibold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <div class="max-w-md mx-auto p-4">
        <form id="reportForm">
            <div class="bg-white rounded-2xl p-6 shadow-xl border border-blue-100"> 
                
                <!-- Header -->
                <div class="text-center mb-8">
                    <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</h1>
                    <p class="text-gray-500 text-sm">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡∏ô‡∏Ñ‡∏£‡∏´‡∏•‡∏ß‡∏á</p>
                </div>

                <!-- Hidden User ID -->
                <input type="hidden" id="userlineId" name="userlineId">

                <!-- 1. Topic Selection -->
                <div class="mb-5">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á <span class="text-red-500">*</span></label>
                    <div class="grid grid-cols-1 gap-3">
                        <label class="cursor-pointer relative">
                            <input type="radio" name="issueType" value="‡∏ó‡πà‡∏≠‡πÅ‡∏ï‡∏Å‡∏£‡∏±‡πà‡∏ß" class="peer sr-only" checked>
                            <div class="p-3 border border-gray-200 rounded-xl hover:bg-blue-50 peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 transition flex items-center gap-3">
                                <span class="w-2 h-2 rounded-full bg-blue-500 opacity-0 peer-checked:opacity-100"></span>
                                üíß ‡∏ó‡πà‡∏≠‡πÅ‡∏ï‡∏Å‡∏£‡∏±‡πà‡∏ß
                            </div>
                        </label>
                        <label class="cursor-pointer relative">
                            <input type="radio" name="issueType" value="‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•/‡πÑ‡∏´‡∏•‡∏≠‡πà‡∏≠‡∏ô" class="peer sr-only">
                            <div class="p-3 border border-gray-200 rounded-xl hover:bg-blue-50 peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 transition flex items-center gap-3">
                                <span class="w-2 h-2 rounded-full bg-blue-500 opacity-0 peer-checked:opacity-100"></span>
                                üöø ‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏• / ‡πÑ‡∏´‡∏•‡∏≠‡πà‡∏≠‡∏ô
                            </div>
                        </label>
                        <label class="cursor-pointer relative">
                            <input type="radio" name="issueType" value="‡∏ô‡πâ‡∏≥‡∏Ç‡∏∏‡πà‡∏ô/‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô" class="peer sr-only">
                            <div class="p-3 border border-gray-200 rounded-xl hover:bg-blue-50 peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 transition flex items-center gap-3">
                                <span class="w-2 h-2 rounded-full bg-blue-500 opacity-0 peer-checked:opacity-100"></span>
                                ü¶† ‡∏ô‡πâ‡∏≥‡∏Ç‡∏∏‡πà‡∏ô / ‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 2. Reporter Name -->
                <div class="mb-4">
                    <label for="reporterName" class="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á <span class="text-red-500">*</span></label>
                    <input type="text" id="reporterName" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                </div>

                <!-- 3. Phone -->
                <div class="mb-4">
                    <label for="phoneNumber" class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-500">*</span></label>
                    <input type="tel" id="phoneNumber" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="08xxxxxxxx" maxlength="10">
                </div>

                <!-- 4. Photo Upload -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <label for="fileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition overflow-hidden">
                            <div id="uploadPlaceholder" class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <p class="text-xs text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</p>
                            </div>
                            <img id="imagePreview" class="absolute inset-0 w-full h-full object-cover hidden" />
                            <input id="fileInput" type="file" class="hidden" accept="image/*" />
                        </label>
                    </div>
                </div>

                <!-- 5. Details -->
                <div class="mb-4">
                    <label for="details" class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="details" rows="3" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà... ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï..."></textarea>
                </div>

                <!-- 6. Coordinates (GPS) -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ <span class="text-red-500">*</span></label>
                    <button type="button" onclick="getLocation()" class="w-full bg-indigo-50 text-indigo-600 font-semibold py-2 px-4 rounded-xl border border-indigo-200 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    </button>
                    <input type="hidden" id="coordinates" name="coordinates">
                    <div id="mapPreview" class="map-preview hidden">
                        <iframe id="mapFrame" width="100%" height="100%" frameborder="0" style="border:0" allowfullscreen></iframe>
                    </div>
                    <p id="locationStatus" class="text-xs text-gray-500 mt-2 text-center"></p>
                </div>

                <button type="button" id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">
                    ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </button>
            </div>
        </form>
    </div>

    <script>
        // *** CONFIGURATION ***
        // ‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (URL ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÉ‡∏ô code.gs)
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzKKmAmPlOXxSeALUDe3fr3YLBYXCwEwfNoJbJelKUeg-kvQcQpID7M0qPHVXIN0aUc/exec'; 
        const LIFF_ID = '1657790891-40VQpd6O'; 

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const submitBtn = document.getElementById('submitBtn');

        // Initialize LIFF
        window.onload = async function() {
            loadingOverlay.style.display = 'flex';
            document.getElementById('loadingText').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...';
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    document.getElementById('userlineId').value = profile.userId;
                    // Auto-fill name if available (Optional)
                    // document.getElementById('reporterName').value = profile.displayName; 
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF Error', err);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        };

        // Image Preview Logic
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        // Geolocation Logic
        function getLocation() {
            const status = document.getElementById('locationStatus');
            const mapPreview = document.getElementById('mapPreview');
            const mapFrame = document.getElementById('mapFrame');

            status.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
            
            if (!navigator.geolocation) {
                status.textContent = "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const coordString = `${lat},${lng}`;
                    
                    document.getElementById('coordinates').value = coordString;
                    status.innerHTML = `<span class="text-green-600">‚úì ‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(6)}, ${lng.toFixed(6)}</span>`;
                    
                    // Show Map Preview (Embed without API Key works for simple views)
                    mapPreview.classList.remove('hidden');
                    mapFrame.src = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
                },
                () => {
                    status.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS";
                }
            );
        }

        // Convert File to Base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                let reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Submit Logic
        submitBtn.addEventListener('click', async () => {
            // Validation
            const issueType = document.querySelector('input[name="issueType"]:checked').value;
            const name = document.getElementById('reporterName').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();
            const details = document.getElementById('details').value.trim();
            const coords = document.getElementById('coordinates').value;
            const userlineId = document.getElementById('userlineId').value;
            const file = fileInput.files[0];

            if (!name || !phone || !coords || !file) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ * ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î)', 'warning');
                return;
            }

            // Confirm
            const confirm = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏',
                text: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#2563EB'
            });

            if (!confirm.isConfirmed) return;

            // Prepare Data
            loadingOverlay.style.display = 'flex';
            document.getElementById('loadingText').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            submitBtn.disabled = true;

            try {
                const base64 = await getBase64(file);
                
                const payload = {
                    userlineId: userlineId,
                    issueType: issueType,
                    reporterName: name,
                    phoneNumber: phone,
                    details: details,
                    coordinates: coords,
                    imageName: file.name,
                    imageMime: file.type,
                    imageBase64: base64
                };

                // Send to Google Script
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß', 'success');
                    liff.closeWindow();
                } else {
                    throw new Error('Server returned ' + response.status);
                }

            } catch (error) {
                console.error(error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                loadingOverlay.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
